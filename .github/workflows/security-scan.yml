name: Security Scan Docker Packages
run-name: >
  Security Scan #${{ github.run_number }} for ${{ inputs.image != '' && inputs.image != null && inputs.image || 'all repository docker images' }}
on:
  workflow_dispatch:
    inputs:
      target:
        description: "Target type for the scan (docker, etc.)"
        required: false
        type: choice
        options:
          - docker
          - source
      image:
        description: "Docker image (for docker). By default ghcr.io/<owner>/<repo>:latest"
        required: false
        default: ""
        type: string
      tag:
        description: "Tag of the image to scan. By default 'latest'"
        required: false
        default: "latest"
        type: string
      only-high-critical:
        description: "Scope only HIGH + CRITICAL"
        required: false
        default: true
        type: boolean
      trivy-scan:
        description: "Trivy scan"
        required: false
        default: true
        type: boolean
      grype-scan:
        description: "Grype scan"
        required: false
        default: true
        type: boolean
      continue-on-error:
        description: "Continue on error"
        required: false
        default: true
        type: boolean
      only-fixed:
        description: "Ignore unfixed vulnerabilities"
        required: false
        default: true
        type: boolean
  schedule:
    - cron: "0 3 * * 0" # every Sunday at 03:00 UTC

jobs:
  # debug-packages:
  #   runs-on: ubuntu-latest
  #   permissions:
  #     packages: read
  #   outputs:
  #     packages: ${{ steps.ghcr.outputs.packages }}
  #     has-packages: ${{ steps.ghcr.outputs.has-packages }}
  #   steps:
  #     - name: List GHCR packages for this repo
  #       id: ghcr
  #       uses: Netcracker/qubership-workflow-hub/actions/ghcr-discover-repo-packages@b6d2198c722564e250d985a99990230d85b0d686 #v2.0.3
  #       env:
  #         GH_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}

  #     - name: Print packages
  #       run: echo "$OUTPUT_PACKAGES" | jq '.'
  #       env:
  #         OUTPUT_PACKAGES: '${{ steps.ghcr.outputs.packages }}'

  #     - name: Continue only if repo has GHCR packages
  #       if: ${{ steps.ghcr.outputs.has-packages == 'true' }}
  #       run: echo "Packages found!"
  load-configuration:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      scan-configuration: ${{ steps.config.outputs.scan-configuration }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load Docker Configuration
        id: load_component
        run: |
          CONFIG_FILE="$GITHUB_WORKSPACE/.qubership/dev-docker.cfg"

          # Проверяем структуру файла
          verify=$(jq '
            def verify_structure:
              has("build") and (.build.registry | type == "string") and
              has("security") and (.security.defaults | type == "object") and
              has("components") and (.components | type == "array") and
              has("platforms") and (.platforms | type == "string");
            verify_structure
            | if . then true else false end
          ' "$CONFIG_FILE")

          if [ "${verify}" != "true" ]; then
            echo "❗ $CONFIG_FILE file is invalid"
            echo "❗ $CONFIG_FILE file is invalid" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

          echo "✅ $CONFIG_FILE file is valid"
          echo "=== PER COMPONENT SECURITY ==="
              jq '
                .security.defaults as $def
                | .components[]
                | {
                    name,
                    security,
                    effective_scan: (.security.scan // $def.scan)
                  }
              ' "$CONFIG_FILE"

          security_items=$(jq -c '
            . as $root
            | $root.security.defaults as $def
            | [
                .components[]
                | .security as $sec
                | select(($sec.scan // $def.scan) == true)
                | {
                    name: .name,
                    image: ($root.build.registry + .name),
                    tag: .tags,
                    only_high_critical: ($sec.only_high_critical // $def.only_high_critical),
                    trivy_scan:         ($sec.trivy_scan         // $def.trivy_scan),
                    grype_scan:         ($sec.grype_scan         // $def.grype_scan),
                    only_fixed:         ($sec.only_fixed         // $def.only_fixed),
                    continue_on_error:  ($sec.continue_on_error  // $def.continue_on_error)
                  }
              ]
          ' "$CONFIG_FILE")

          echo "security_items=${security_items}" >> "$GITHUB_OUTPUT"

          echo "Loaded security scan configuration:"
          echo "$security_items" | jq .

  # security-scan-matrix:
  #   permissions:
  #     contents: read
  #     security-events: write
  #     packages: read
  #   needs: debug-packages
  #   if: ${{ inputs.image == '' || inputs.image == null }}
  #   strategy:
  #     matrix:
  #       package: ${{ fromJson(needs.debug-packages.outputs.packages) }}

  #   name: "Run Security Scan (matrix)"
  #   uses: netcracker/qubership-workflow-hub/.github/workflows/re-security-scan.yml@b6d2198c722564e250d985a99990230d85b0d686 #v2.0.3
  #   with:
  #     target: ${{ inputs.target || 'docker' }}
  #     image: ${{ format('{0}:{1}', matrix.package.path, inputs.tag || 'latest') }}

  # security-scan-single:
  #   permissions:
  #     contents: read
  #     security-events: write
  #     packages: read
  #   needs: debug-packages
  #   if: ${{ inputs.image != '' && inputs.image != null }}
  #   name: "Run Security Scan (single image)"
  #   uses: netcracker/qubership-workflow-hub/.github/workflows/re-security-scan.yml@b6d2198c722564e250d985a99990230d85b0d686 #v2.0.3
  #   with:
  #     target: ${{ inputs.target || 'docker' }}
  #     image: ${{ inputs.image }}
  #     only-high-critical: ${{ inputs.only-high-critical || true }}
  #     trivy-scan: ${{ inputs.trivy-scan || true }}
  #     grype-scan: ${{ inputs.grype-scan || true }}
  #     only-fixed: ${{ inputs.only-fixed || true }}
  #     continue-on-error: ${{ inputs.continue-on-error || true }}
