---
name: 'Run NiFi in plain mode and execute autotests'
description: 'Runs NiFi and Consul containers and executes autotests'
runs:
  using: "composite"
  steps:
    - name: Prepare libs
      shell: bash
      run: |
        echo "Preparing libs..."
        chmod +x .github/workflows/sh/*.sh
        . .github/workflows/sh/nifi-lib.sh
        echo "Generate temporary sensitive key"
        export NIFI_SENSITIVE_KEY=$(generate_random_hex_password 14)
        echo "$NIFI_SENSITIVE_KEY" > ./nifi-sens-key.tmp
    - name: Run local nifi
      shell: bash
      run: |
        export NIFI_SENSITIVE_KEY=$(cat ./nifi-sens-key.tmp)
        echo "Starting containers (nifi, consul)..."
        docker compose -f .github/docker/plain/docker-compose.yaml up -d
    - name: Display running containers
      shell: bash
      run: docker ps
    - name: Wait for nifi container to start
      shell: bash
      continue-on-error: true
      run: |
        . .github/workflows/sh/nifi-lib.sh
        echo "Sleep for 15 seconds:"
        sleep 15
        echo "Wait for nifi container to start:"
        wait_success="1"
        #TODO: add timeout parameter to action
        wait_for_nifi "false" "60" "127.0.0.1" "8080" || wait_success="0"
        #TODO: handle error scenario
        if [ "$wait_success" == '0' ]; then
          echo "Wait failed, nifi not available. Last 2k lines of logs for container:"
          docker logs -n 2000 local-nifi-plain
        fi
    - name: Run nifi API tests
      shell: bash
      continue-on-error: true
      run: |
        gitDir="$(pwd)"
        collectionsDir="${gitDir}/.github/workflows/collections"
        echo "Running newman using collections from $collectionsDir"
        echo "Run basic NiFi API tests..."
        docker run  --net=host --rm -v "$collectionsDir:/etc/newman" postman/newman:alpine run "NiFi Basic API Tests.postman_collection.json" --environment="NiFi_AT.json.postman_environment" -r cli,junit
    - name: Cleanup after tests
      shell: bash
      continue-on-error: true
      run: |
        export NIFI_SENSITIVE_KEY=$(cat ./nifi-sens-key.tmp)
        echo "Stopping and removing containers"
        docker compose -f .github/docker/plain/docker-compose.yaml down